# BMS Modbus TCP 模擬器說明文件

這是一個基於 Python `pymodbus` 庫開發的電池管理系統（BMS）模擬器。它能模擬 12 串電池組的電壓、電流、溫度及保護邏輯，並透過 Modbus TCP 協定對外提供數據交換。

## 1. 概述 (Overview)

本模擬器旨在提供一個虛擬的 BMS 環境，用於測試上位機（如 SCADA、PLC 或自定義監控軟體）。模擬器內部包含一個簡易的物理模型，會根據電流大小計算電壓降與溫升，並自動觸發警報與狀態切換。

* **通訊協定**: Modbus TCP
* **預設埠號**: `7001`
* **資料格式**: 16-bit 無符號整數 (U16)，部分暫存器需處理正負號 (Two's Complement)
* **更新頻率**: 物理計算每 1 秒執行一次，Modbus 暫存器每 3 秒同步一次

---

## 2. 暫存器規格 (Tag Spec)

以下為本模擬器支援的 Holding Register 定義：

### A. 唯讀狀態暫存器 (Read Only)

| 地址 (Addr) | 名稱 | 縮放倍率 (Scale) | 單位/說明 |
| :--- | :--- | :--- | :--- |
| **1440** | 額定容量 (Nominal Ah) | 0.1 | Ah |
| **1441** | 剩餘電量 (Stored Ah) | 0.1 | Ah |
| **1442** | 即時電流 (Actual Current) | 0.1 | A (帶符號，需處理補碼) |
| **1443** | 總電壓 (Pack Voltage) | 0.01 | V |
| **1444** | 最高單體電壓 | 0.001 | V |
| **1445** | 最低單體電壓 | 0.001 | V |
| **1446** | 最高單體溫度 | 0.1 | °C |
| **1447** | 最低單體溫度 | 0.1 | °C |
| **1448** | 最高/低電壓位置 (Low Byte) | 1 | High: Max Idx / Low: Min Idx |
| **1449** | 最高/低溫度 VMS ID | 1 | U16 |
| **1450** | 健康度 (SOH) | 0.01 | % |
| **1451** | 工作狀態 (Working Status) | 1 | 位元遮罩 (Bitmask) |
| **1452** | 警報狀態 (Alarm Status) | 1 | 位元遮罩 (Bitmask) |
| **1453** | 最高/低電壓位置 (High Byte) | 1 | High: Max Idx / Low: Min Idx |

### B. 可寫入指令暫存器 (Writable)
*初始化值皆為 0，且不會隨模擬器自動變更。*

| 地址 (Addr) | 指令名稱 | 說明 |
| :--- | :--- | :--- |
| **1596** | cmd04 | 設定平衡模式 (Set Balance mode) |
| **1598** | cmd05 | 保留指令 |
| **1599** | cmd07 | 強制寫入補償係數 37 (0x25) |
| **1642** | cmd06 | 強制解除保護 (2s) 並進入預充電 |
| **6452** | cmd03 | 強制斷電模式 |
| **10077** | cmd02 | 解除強制斷電模式 |
| **15115** | cmd01 | 解碼指令 |

---

## 3. 模擬器說明 (Simulator Logic)

### 物理模擬機制
* **電壓變化**: 模擬器採用基礎開路電壓 (OCV) 模型，並根據 $V = V_{ocv} - I \times R$ 計算動態壓降。
* **電流模擬**: 隨機產生 -30A 至 +30A 的電流，模擬充放電切換。
* **容量更新**: 根據電流積分（安時積分法）即時更新 `Stored Ah`，並在滿充/放電時自動修正。
* **溫度邏輯**: 電流絕對值越大，產生的焦耳熱越多，溫度會隨之緩慢上升。

### 狀態與保護
* **警報 (Alarm)**: 當單體電壓 > 4.2V、< 3.0V 或溫度過高時，`HR_ALARM_STATUS` 相應位元會自動變更。
* **永久鎖定 (Permanent Lock)**: 若觸發嚴重保護（如電壓過高 > 4.35V），模擬器將進入永久鎖定狀態（Status Bit 7）。

### 使用方式
1. 確保已安裝 `pymodbus`:
   ```bash
   pip install pymodbus
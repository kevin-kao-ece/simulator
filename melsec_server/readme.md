# MELSEC MC 協議 (3E Binary) 模擬器

本專案是一個基於 Python 的高性能 **Mitsubishi MELSEC MC 協議 (QnA 3E Frame Binary)** 模擬器。它允許 HMI、SCADA 系統和其他工業客戶端透過 TCP/IP 與虛擬 PLC 進行互動。

## 1. 系統規範
* **通訊協定**: MELSEC MC Protocol (3E Frame Binary)
* **通訊埠 (Port)**: `6001`
* **模式**: 多執行緒（支援多個客戶端同時連線）
* **位元組順序 (Endianness)**: Little-Endian（MELSEC Binary 標準）

## 2. 配置的設備記憶體 (Device Memory)
模擬器根據 `config.yaml` 定義分配虛擬記憶體：

暫存器地址以 10 進位為依據

### 字組設備 (Word Devices - 16位元)
| 設備名稱 | 代碼 (Hex) | 地址範圍 | 總點數 | 用途 |
| :--- | :--- | :--- | :--- | :--- |
| **D** | `0xA8` | 0 - 65535 | 65,536 | 一般資料暫存器 |
| **W** | `0xB4` | 0 - 65535 | 65,536 | 鏈結暫存器 |
| **R** | `0xAF` | 0 - 32767 | 32,768 | 檔案暫存器 |
| **ZR** | `0xB0` | 0 - 65535 | 65,536 | 連續檔案暫存器 |
| **TN** | `0xC2` | 0 - 2047 | 2,048 | 計時器當前值 |
| **CN** | `0xC5` | 0 - 1023 | 1,024 | 計數器當前值 |

### 位元設備 (Bit Devices - 1位元)
| 設備名稱 | 代碼 (Hex) | 地址範圍 | 用途 |
| :--- | :--- | :--- | :--- |
| **M** | `0x90` | 0 - 32767 | 內部繼電器 |
| **X** | `0x9C` | 0 - 4095 | 輸入 (DI) |
| **Y** | `0x9D` | 0 - 4095 | 輸出 (DO) |
| **TS** | `0xC1` | 0 - 2047 | 計時器觸點 |
| **CS** | `0xC4` | 0 - 1023 | 計數器觸點 |

## 3. 模擬馬達邏輯 (Simulated Motor Logic)
模擬器內建了一個物理引擎，模擬真實世界的馬達狀態。

### 運作邏輯
* **初始狀態**: **Y0** 預設初始化為 `1` (ON)，馬達會在啟動時自動運轉。
* **控制**: 如果將 **Y0** 寫入 `0`，馬達轉速 (RPM) 將逐漸降至零。
* **回授**: **X0** 反映馬達運轉狀態 (1 = 運轉中, 0 = 已停止)。

### 監控位址 (資料對照)
| PLC 位址 | 功能 | 資料類型 | `D` 區位元組偏移量 |
| :--- | :--- | :--- | :--- |
| **Y0** | 馬達啟動/停止 | Bit | `self.memory[0x9D][0]` |
| **X0** | 運轉回授 | Bit | `self.memory[0x9C][0]` |
| **D10** | 馬達轉速 (RPM) | Word (U16) | `self.memory[0xA8][20:22]` |
| **D11** | 馬達電流 (Amps) | Word (U16) | `self.memory[0xA8][22:24]` |
| **M10** | 過載故障 | Bit | `self.memory[0x90][10]` |

## 4. 技術實作說明
* **位元組定址**: 字組位址計算方式為 $位址 \times 2$（例如：D10 位在索引 20 處）。
* **模擬迴圈**: `update_loop` 每 100 毫秒執行一次，提供平滑的 RPM 升降斜率。
* **安全機制**: 如果 RPM 超過 `1800`，過載位元 **M10** 將自動設為 High。

## 5. 快速開始
1. 安裝依賴項目：`pip install pyyaml`
2. 啟動模擬器：`python main.py`
3. 將 HMI/客戶端連線至 `127.0.0.1:6001`，使用 MELSEC QnA 3E Binary TCP。